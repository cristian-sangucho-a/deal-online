---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from "../components/Footer.astro";
---

<Layout title="Recuperar Contraseña - Deal Online">
  <Header />

  <div class="min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
    <div class="sm:mx-auto sm:w-full sm:max-w-md">
      <div class="text-center">
        <h2 class="text-3xl font-bold text-gray-900">Recuperar Contraseña</h2>
        <p class="mt-2 text-gray-600" id="step-description">
          Ingresa tu correo electrónico y te enviaremos un código de verificación.
        </p>
      </div>
    </div>

    <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
      <div class="bg-white py-8 px-4 shadow-lg sm:rounded-lg sm:px-10">
        <form id="forgot-form" class="space-y-6">
          <div id="error-message" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg">
            <div class="flex">
              <svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
              </svg>
              <div class="ml-3">
                <p class="text-red-800 text-sm" id="error-text"></p>
              </div>
            </div>
          </div>

          <div id="success-message" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex">
              <svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <div class="ml-3">
                <p class="text-green-800 text-sm" id="success-text"></p>
              </div>
            </div>
          </div>

          <!-- Paso 1: Ingresar email -->
          <div id="email-step">
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700">
                Correo Electrónico
              </label>
              <div class="mt-1">
                <input 
                  id="email" 
                  name="email" 
                  type="email" 
                  autocomplete="email" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                  placeholder="tu@email.com"
                />
              </div>
            </div>

            <div>
              <button 
                type="submit" 
                id="submit-btn"
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                <span id="submit-text">Enviar Código</span>
                <svg id="loading-spinner" class="hidden animate-spin ml-2 w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Paso 2: Ingresar código de verificación -->
          <div id="code-step" class="hidden space-y-6">
            <div>
              <label for="verification-code" class="block text-sm font-medium text-gray-700">
                Código de Verificación
              </label>
              <div class="mt-1">
                <input 
                  id="verification-code" 
                  name="verificationCode" 
                  type="text" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                  placeholder="123456"
                />
              </div>
              <p class="mt-2 text-sm text-gray-500">
                Ingresa el código de 6 dígitos que enviamos a tu correo.
              </p>
            </div>

            <div class="flex justify-between">
              <button 
                type="button" 
                id="back-to-email-btn"
                class="py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
              >
                Volver
              </button>
              <button 
                type="button" 
                id="verify-code-btn"
                class="py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
              >
                Verificar Código
              </button>
            </div>
          </div>

          <!-- Paso 3: Cambiar contraseña -->
          <div id="password-step" class="hidden space-y-6">
            <div>
              <label for="new-password" class="block text-sm font-medium text-gray-700">
                Nueva Contraseña
              </label>
              <div class="mt-1">
                <input 
                  id="new-password" 
                  name="newPassword" 
                  type="password" 
                  minlength="6"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                  placeholder="••••••••"
                />
              </div>
            </div>

            <div>
              <label for="confirm-password" class="block text-sm font-medium text-gray-700">
                Confirmar Nueva Contraseña
              </label>
              <div class="mt-1">
                <input 
                  id="confirm-password" 
                  name="confirmPassword" 
                  type="password" 
                  minlength="6"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                  placeholder="••••••••"
                />
              </div>
            </div>

            <div>
              <button 
                type="button" 
                id="reset-password-btn"
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
              >
                Cambiar Contraseña
              </button>
            </div>
          </div>

          <div class="text-sm text-center">
            <a href="/login" class="text-primary-600 hover:text-primary-500 font-medium">
              Volver al inicio de sesión
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
  <Footer />
</Layout>

<script>
  // Solo ejecutar en el cliente
  if (typeof window !== 'undefined') {
    // Import dinámico del API para evitar errores de SSR
    import('../services/api.js').then(({ api }) => {
      const emailForm = document.getElementById('forgot-form');
      const emailStep = document.getElementById('email-step');
      const codeStep = document.getElementById('code-step');
      const passwordStep = document.getElementById('password-step');
      const stepDescription = document.getElementById('step-description');
      
      const submitBtn = document.getElementById('submit-btn');
      const submitText = document.getElementById('submit-text');
      const loadingSpinner = document.getElementById('loading-spinner');
      const errorMessage = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');
      const successMessage = document.getElementById('success-message');
      const successText = document.getElementById('success-text');
      
      const verifyCodeBtn = document.getElementById('verify-code-btn');
      const backToEmailBtn = document.getElementById('back-to-email-btn');
      const resetPasswordBtn = document.getElementById('reset-password-btn');
      
      let currentEmail = '';

      function showError(message) {
        errorText.textContent = message;
        errorMessage.classList.remove('hidden');
        successMessage.classList.add('hidden');
        // Scroll to error message
        errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      function showSuccess(message) {
        successText.textContent = message;
        successMessage.classList.remove('hidden');
        errorMessage.classList.add('hidden');
        // Scroll to success message
        successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      function hideMessages() {
        errorMessage.classList.add('hidden');
        successMessage.classList.add('hidden');
      }

      function setLoading(loading) {
        submitBtn.disabled = loading;
        if (loading) {
          submitText.textContent = 'Enviando...';
          loadingSpinner.classList.remove('hidden');
        } else {
          submitText.textContent = 'Enviar Código';
          loadingSpinner.classList.add('hidden');
        }
      }

      function showStep(step) {
        emailStep.classList.add('hidden');
        codeStep.classList.add('hidden');
        passwordStep.classList.add('hidden');
        
        switch(step) {
          case 'email':
            emailStep.classList.remove('hidden');
            stepDescription.textContent = 'Ingresa tu correo electrónico y te enviaremos un código de verificación.';
            break;
          case 'code':
            codeStep.classList.remove('hidden');
            stepDescription.textContent = 'Ingresa el código de verificación que enviamos a tu correo.';
            break;
          case 'password':
            passwordStep.classList.remove('hidden');
            stepDescription.textContent = 'Crea una nueva contraseña para tu cuenta.';
            break;
        }
      }

      // Paso 1: Enviar código al email
      emailForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideMessages();

        const email = document.getElementById('email').value.trim();
        currentEmail = email;

        if (!email) {
          showError('Por favor ingresa tu correo electrónico');
          document.getElementById('email').focus();
          return;
        }

        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          showError('Ingresa un email válido');
          document.getElementById('email').focus();
          return;
        }

        setLoading(true);

        try {
          const result = await api.requestPasswordReset(email);
          showSuccess('Código de verificación enviado. Revisa tu correo electrónico.');
          showStep('code');
        } catch (error) {
          console.error('Error al enviar código:', error);
          showError(error.message || 'Error al enviar el código de verificación');
        } finally {
          setLoading(false);
        }
      });

      // Paso 2: Volver al paso de email
      backToEmailBtn.addEventListener('click', () => {
        showStep('email');
      });

      // Paso 2: Verificar el código
      verifyCodeBtn.addEventListener('click', async () => {
        hideMessages();
        
        const verificationCode = document.getElementById('verification-code').value.trim();
        
        if (!verificationCode) {
          showError('Por favor ingresa el código de verificación');
          document.getElementById('verification-code').focus();
          return;
        }

        if (verificationCode.length !== 6) {
          showError('El código debe tener 6 dígitos');
          document.getElementById('verification-code').focus();
          return;
        }

        try {
          const result = await api.verifyResetCode(currentEmail, verificationCode);
          showSuccess('Código verificado correctamente. Ahora puedes cambiar tu contraseña.');
          showStep('password');
        } catch (error) {
          console.error('Error al verificar código:', error);
          showError(error.message || 'Código inválido o expirado');
        }
      });

      // Paso 3: Cambiar contraseña
      resetPasswordBtn.addEventListener('click', async () => {
        hideMessages();
        
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const verificationCode = document.getElementById('verification-code').value;
        
        if (!newPassword) {
          showError('Por favor ingresa una nueva contraseña');
          document.getElementById('new-password').focus();
          return;
        }
        
        if (newPassword.length < 6) {
          showError('La contraseña debe tener al menos 6 caracteres');
          document.getElementById('new-password').focus();
          return;
        }

        if (!confirmPassword) {
          showError('Por favor confirma tu nueva contraseña');
          document.getElementById('confirm-password').focus();
          return;
        }

        if (newPassword !== confirmPassword) {
          showError('Las contraseñas no coinciden');
          document.getElementById('confirm-password').focus();
          return;
        }

        try {
          const result = await api.resetPassword(currentEmail, verificationCode, newPassword);
          showSuccess('Contraseña cambiada exitosamente. Redirigiendo al inicio de sesión...');
          
          // Redireccionar al login después de 2 segundos
          setTimeout(() => {
            window.location.href = '/login?passwordChanged=true';
          }, 2000);
          
        } catch (error) {
          console.error('Error al cambiar contraseña:', error);
          showError(error.message || 'Error al cambiar la contraseña');
        }
      });

    }).catch(error => {
      console.error('Error loading API:', error);
      const errorMessage = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');
      if (errorMessage && errorText) {
        errorText.textContent = 'Error al cargar la aplicación. Recarga la página.';
        errorMessage.classList.remove('hidden');
      }
    });
  }
</script>